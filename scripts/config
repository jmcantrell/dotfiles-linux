#!/usr/bin/env bash

set -eu

# Add file system modifications.
sudo rsync -v --archive --no-owner --no-group ./files/root/ /

# Needed to change screen brightness.
sudo gpasswd --add "$USER" video

# Needed to update locate database without sudo.
sudo gpasswd --add "$USER" locate
updatedb

# Set preferred shell.
sudo chsh --shell /bin/zsh "$USER"

# Enable periodic btrfs snappshotting.
if [[ $(stat -fc "%T" /) == btrfs ]]; then
    sudo systemctl enable --now btrfs-snapshots-{create,prune}.timer
fi

# Enable desktop tools.
systemctl --user enable --now {mako,udiskie,swayidle}.service

# Only enable battery monitoring if a battery exists.
if [[ -e /sys/class/power_supply/BAT0 ]]; then
    systemctl --user enable --now check-battery.timer
fi

# Manage user temp files with systemd-tmpfiles.
tmp_conf=$HOME/.config/user-tmpfiles.d/tmp.conf
mkdir -p "$(dirname "$tmp_conf")"
echo "d $HOME/.local/tmp 0700 $USER $USER 10d" >"$tmp_conf"
systemctl --user enable --now systemd-tmpfiles-{setup.service,clean.timer}
