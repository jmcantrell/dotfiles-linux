#!/usr/bin/env sh

# Download a minecraft forge installer in the current directory.
# Usage: file=`get-minecraft-forge [version]`

set -e

die() {
    echo "$@" >&2
    exit 1
}

me=${0##*/}

package=${package:-installer}
version=${1:-`minecraft-version-latest`}

index=`mktemp -t $me.XXXXXXXXXX`
trap "rm -f '$index'" INT TERM EXIT

url=http://files.minecraftforge.net

# cache page for multiple operations
indexurl=$url/maven/net/minecraftforge/forge/index_$version.html
curl -sL -o "$index" "$indexurl" || die "Could not get index page"

build=`
    grep latest "$index" |
    grep '^ *[0-9]' |
    sed -e 's/^ *//' -e 's/<.*//'
    `

test "$build" || die "Unable to get the latest forge version for $version"

path=`
    grep "Direct Download" "$index" |
    grep "forge-$version-$build-$package" |
    head -n1 | sed 's/.*href="\([^"]\+\)".*/\1/'
    `
file=${path##*/}

test "$file" || die "Could not parse filename"

if ! test -f "$file"; then
    curl -sL -o "$file" "$url/$path" || die "Could not download package"
fi

echo "$file"
