#!/usr/bin/env bash

set -eu

me=${0##*/}
usage="Sound an alarm after a specified amount of time.

Usage: $me [-h] [-n NAME] TIMESPEC

Options:
    -h           show this help message
    -n NAME      give the timer a descriptive name

See the --date option in date(1) for definition of TIMESPEC.

Examples:
    timer 1 minute
    timer -n laundry 45 minutes
    timer -n 'boat tour' 3 hours
    timer -n 'very specific' now + 1 hour + 10 minutes
"

usage() {
    echo "$usage" >&2
    exit 0
}

die() {
    echo "$me: $*" >&2
    exit 1
}

name=
unset OPTIND OPTARG
while getopts ":hn:" option; do
    case $option in
    h) usage ;;
    n) name=$OPTARG ;;
    *) die "invalid option: $OPTARG" ;;
    esac
done && shift $((OPTIND - 1))
unset option OPTIND OPTARG

(($# > 0)) || die "missing time specification"

at "$(date -d "$*" +"%H:%M %Y-%m-%d")" <<-EOF
export DISPLAY=$DISPLAY
canberra-gtk-play -i alarm-clock-elapsed &
notify-send -u critical "Timer Elapsed" "$name"
EOF
