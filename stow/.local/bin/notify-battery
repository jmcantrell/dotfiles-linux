#!/usr/bin/env bash

# Display battery warnings and hibernate when almost empty.

set -eu

battery_num=0
low_percent=25
critical_percent=15
hibernate_percent=5
hibernate_delay=30

info=$(
    acpi -b |
        grep -i "^battery $battery_num:" |
        awk '{print $3, $4}' |
        sed -re 's/[^0-9A-Za-z ]//g'
)
state=${info%% *}
percent=${info##* }

if [[ $state == Discharging ]]; then
    if ((percent <= hibernate_percent)); then
        notify-send -u critical -i battery-empty \
            "Battery almost empty: $percent%" \
            "Hibernating in $hibernate_delay seconds..."
        sleep "$hibernate_delay" && systemctl hibernate
    elif ((percent <= critical_percent)); then
        notify-send -u critical -i battery-caution \
            "Battery critical: $percent%" \
            "Hibernation at $hibernate_percent%"
    elif ((percent <= low_percent)); then
        notify-send -u critical -i battery-low \
            "Battery low: $percent%" \
            "Attach power supply to avoid hibernation"
    fi
fi
