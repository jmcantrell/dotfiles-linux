#!/usr/bin/env bash

set -eu

length=16

name=${0##*/}
usage="Use dmenu to interact with pass.

Usage:
    $name [OPTIONS] [ACTION]

Options:
    -n NUMBER    generated password length (default: $length)

Actions:
    choose       choose existing password
    generate     generate a new password

In all cases, the password is copied to the clipboard.
"

pass_dir=${PASSWORD_STORE_DIR:-$HOME/.password-store}

usage() {
    echo "$usage" >&2
    exit 0
}

die() {
    echo "ERROR: $*" >&2
    exit 1
}

pass_names() {
    if [[ -d $pass_dir ]]; then
        while IFS= read -r -d'' file; do
            name=${file#"$pass_dir"/}
            name=${name%.gpg}
            echo "$name"
        done < <(find -L "$pass_dir" -type f -name "*.gpg" -print0)
    fi
}

while getopts ":n:h" option; do
    case $option in
    n) length=$OPTARG ;;
    h) usage ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:-choose}

case $action in
choose | generate) ;;
*) die "Invalid action '$action'" ;;
esac

name=$(pass_names | dmenu -p "$action password for")

case $action in
choose) pass -c "$name" ;;
generate) pass generate -c -f "$name" "$length" ;;
esac

notify-send -i edit-copy \
    "Password for $name copied to the clipboard" \
    "Self-destructing in <b>45</b> seconds..."
