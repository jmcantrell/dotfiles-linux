#!/usr/bin/env bash

# Run commands with dmenu, sorted by most recently used.

set -eu

histsize=${DMENU_HISTSIZE:-100}
mru_file=${XDG_CACHE_HOME:-$HOME/.cache}/dmenu/run-mru

mkdir -p "$(dirname "$mru_file")"
touch "$mru_file"

temp=$(mktemp -t "${0##*/}.XXXXXXXXXX")
trap 'rm -f "$temp"' INT TERM EXIT

mru_path() {
    cat "$mru_file"                       # Shift the most recent to the top
    dmenu-path | grep -vxF -f "$mru_file" # ... from the full list of commands.
}

mru_add() {
    local cmd=${1:?missing command}
    {
        echo "$cmd"                 # Shift the most recent to the top
        grep -vx "$cmd" "$mru_file" # ... from the previous MRU.
    } | head -n"$histsize" >"$temp" # Letting the least recent drop off.
    mv -f "$temp" "$mru_file"       # Swap out the previous MRU.
}

cmd=$(mru_path | dmenu -i -p run "$@")
mru_add "$cmd"
exec "$cmd"
