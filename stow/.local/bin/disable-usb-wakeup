#!/usr/bin/env bash

# Disable the ability for USB devices to wake up the system.

set -e

wakeup="/proc/acpi/wakeup"
service="/etc/systemd/system/disable-usb-wakeup.service"

devices=$(grep -Ev '^[[:space:]]' "$wakeup" | grep -E '^(EHC|XHC)' | awk '{print $1}')
devices=$(printf "%s" "${devices[@]}")

sudo tee "$service" >/dev/null <<-EOF
[Unit]
Description=Disable ACPI wakeup by USB devices

[Service]
ExecStart=/bin/bash -c \"echo $devices >>/proc/acpi/wakeup\"

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable --now "$(basename "$service")"
