#!/usr/bin/env bash

# Disable the ability for USB devices to wake up the system.

set -eu

wakeup=/proc/acpi/wakeup
service=/etc/systemd/system/disable-usb-wakeup.service

devices=$(
    grep -v '^[[:space:]]' "$wakeup" |
        grep '^[EX]HC' |
        awk '{print $1}' |
        tr -d '[:space:]'
)

sudo tee "$service" >/dev/null <<-EOF
[Unit]
Description=disable resuming on USB device activity

[Service]
ExecStart=/bin/bash -c "printf '%%s\n' ${devices@Q} >>${wakeup@Q}"

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable --now "$(basename "$service")"
