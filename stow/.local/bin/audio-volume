#!/usr/bin/env bash

# Set the audio volume and show a notification.

set -eu

action=${1:?Missing action}

# The following lock file guard along with the sleep command defined at the end
# of the script will limit how often the volume can be changed, and
# consequently, how often swaystatus will be poked. Sending the refresh signal
# too frequently seemed to be crashing it.

lock_file=$XDG_RUNTIME_DIR/${0##*/}.lock

if [[ -e $lock_file ]]; then
    exit 0
fi

touch "$lock_file"
trap 'rm "$lock_file"' INT TERM EXIT

sink=@DEFAULT_SINK@
increment=5%

case $action in
mute) pactl set-sink-mute "$sink" toggle ;;
up) pactl set-sink-volume "$sink" +"$increment" ;;
down) pactl set-sink-volume "$sink" -"$increment" ;;
max) pactl set-sink-volume "$sink" 100% ;;
[0-9]*) pactl set-sink-volume "$sink" "$action" ;;
esac

read -r left right < <(
    pactl get-sink-volume "$sink" | head -n1 | awk '{print $5,$12}'
)

if [[ "$left" == "$right" ]]; then
    volume=$left
else
    volume="Left: $left, Right: $right"
fi

canberra-gtk-play -i message &
killall -SIGUSR1 swaystatus &

if [[ $(pactl get-sink-mute "$sink") == *yes ]]; then
    icon="audio-volume-muted"
else
    icon="audio-volume-high"
fi

notify-send -u low -i "$icon" -h int:value:"$volume" \
    -h string:x-canonical-private-synchronous:"${0##*/}" \
    "Volume Control" "Volume: $volume"

sleep 0.1
