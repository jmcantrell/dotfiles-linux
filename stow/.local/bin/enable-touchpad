#!/usr/bin/env bash

# Persist settings for a touchpad.

set -euo pipefail

device_name() {
    xinput --list --name-only "${1:?missing device id}"
}

choose_device() {
    echo "Enter the device id to enable:" >&2

    readarray -t ids < <(
        xinput --list | grep -v XTEST |
            grep '\bslave \+pointer\b' |
            cut -f2 | cut -d= -f2
    )

    local id
    for id in "${ids[@]}"; do
        echo "$id) $(device_name "$id")" >&2
    done

    read -r -p "${PS3:-#? }" id

    if ! printf "%s\n" "${ids[@]}" | grep -q "^$id$"; then
        echo "${0##*/}: invalid device id" >&2
        exit 1
    fi

    echo "$id"
}

id=${1:-$(choose_device)}
name=$(device_name "$id")
conf=/etc/X11/xorg.conf.d/99-touchpad-$id.conf

sudo tee "$conf" >/dev/null <<-EOF
Section "InputClass"
	Identifier "touchpad"
	MatchProduct "$name"
	Driver "libinput"
	Option "AccelSpeed"          "1"
	Option "DisableWhileTyping"  "on"
	Option "HorizontalScrolling" "on"
	Option "NaturalScrolling"    "on"
	Option "ScrollMethod"        "twofinger"
	Option "Tapping"             "on"
	Option "TappingButtonMap"    "lrm"
	Option "TappingDrag"         "on"
EndSection
EOF

echo "Change options in: $conf" >&2
