#!/usr/bin/env bash

set -eu

me=${0##*/}
usage="Copy the current working directory of a window to the clipboard.

Usage:
    $me [OPTIONS]

Options:
    -s    select a window (default: current)
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

select_window_id() {
    swaymsg -t get_tree |
        jq -r '.. | select(.id? and .visible?) | .rect + {id} | "\(.x),\(.y) \(.width)x\(.height) \(.id)"' |
        slurp -f "%l"
}

pwd_command=(swaypwd)

while getopts ":sh" option; do
    case $option in
    s) pwd_command+=("$(select_window_id)") ;;
    h) usage ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

cwd=$("${pwd_command[@]}")

wl-copy -n "$cwd"

notify-send -i edit-copy \
    "Directory copied to clipboard:" \
    "<u>$cwd</u>"
