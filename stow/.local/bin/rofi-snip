#!/usr/bin/env bash

set -eu

name=${0##*/}
usage="Manage text snippets with rofi.

Usage:
    $name [OPTIONS] ACTION NAME

Options:
    -C DIRECTORY    directory in which to store snippets

Actions:
    edit            open snippet in editor
    copy            copy snippet to clipboard
    save            save clipboard to snippet
    type            type snippet to active window
    delete          delete snippet
"

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

do_copy() {
    snip "${snip_options[@]}" read "$1" | xsel -ib
    notify-send -i edit-copy "Snippet '$1' copied to clipboard"
}

do_save() {
    xsel -ob | snip "${snip_options[@]}" write "$1"
    notify-send -i document-save "Snippet '$name' saved from clipboard"
}

do_type() {
    xdotool type \
        --clearmodifiers --delay 25 \
        --file "$(snip "${snip_options[@]}" path "$1")"
}

snip_options=()

while getopts ":C:h" option; do
    case $option in
    C) snip_options+=(-C "$OPTARG") ;;
    h)
        printf "%s\n" "$usage"
        exit
        ;;
    *) die "invalid option: $OPTARG" ;;
    esac
done && shift $((OPTIND - 1))

if [[ ! -v 1 ]]; then
    die "Missing action"
fi

action=$1

name=$(snip list | rofi -dmenu -p "$action snippet")

if [[ -z $name ]]; then
    die "No snippet was selected"
fi

case $action in
edit | delete) snip "$action" "$name" ;;
*) do_"$action" "$name" ;;
esac
