#!/usr/bin/env bash

set -eu

device=$1
key_name=$2

config_dir=${XDG_CONFIG_HOME:-$HOME/.config}
config_file=$config_dir/udiskie/config.json
key_file=$config_dir/udiskie-keyfiles/$key_name

if [[ ! -f $key_file ]]; then
    touch "$key_file"
    chmod 600 "$key_file"
    dd bs=512 count=8 if=/dev/urandom of="$key_file"
fi

if ! uuid=$(blkid -s UUID -o value "$device"); then
    echo "could not get UUID for device: $device" >&2
    exit 1
fi

sudo cryptsetup luksAddKey "$device" "$key_file"

if [[ ! -f "$config_file" ]]; then
    jq -n '.device_config=[]' >"$config_file"
fi

index=$(
    jq --arg uuid "$uuid" \
        '.device_config | map(.id_uuid == $uuid) | index(true)' \
        "$config_file"
)

args=(--arg keyfile "${key_file/$HOME/\~}")

if [[ $index == null ]]; then
    args+=(--arg uuid "$uuid")
    # shellcheck disable=SC2016
    query='.device_config += [{ "id_uuid": $uuid, "keyfile": $keyfile }]'
else
    args+=(--arg index "$index")
    # shellcheck disable=SC2016
    query='.device_config[$index | tonumber].keyfile=$keyfile'
fi

jq "${args[@]}" "$query" "$config_file" | sponge "$config_file"
