#!/usr/bin/env bash

set -eu

file_type=${FILE_TYPE:-png}

me=${0##*/}
usage="Capture an image of the desktop.

Usage: $me [OPTIONS] [FILE]

Options:
    -h           show this help message
    -u           capture the current window
    -w           click to select a window to capture
    -s           drag to select a region to capture

Arguments:
    FILE         output capture to FILE

Environment Variables:
    FILE_TYPE    extension to use for capture file name (default: $file_type)
"

usage() {
    echo "$usage" >&2
    exit 0
}

die() {
    echo "ERROR: $*" >&2
    exit 1
}

unset OPTIND OPTARG
while getopts ":huws" option; do
    case $option in
    u)
        name="window"
        geometry=$(xwinrect -id "$(active-window)")
        ;;
    w)
        name="window"
        geometry=$(xwinrect -id "$(selected-window)")
        ;;
    s)
        name="region"
        geometry=$(xrectsel)
        ;;
    h) usage ;;
    *) die "invalid option: $OPTARG" ;;
    esac
done && shift $((OPTIND - 1))
unset option OPTIND OPTARG

timestamp=$(date --iso-8601=seconds)
file=${1:-$(xdg-user-dir PICTURES)/desktop-${name:+$name-}$timestamp.$file_type}
mkdir -p "$(dirname "$file")"

options=(-window root)

if [[ -v geometry ]]; then
    options+=(-crop "$geometry")
fi

import "${options[@]}" "$file"

canberra-gtk-play -i screen-capture &
notify-send -i media-record "Captured Screenshot" "<u>${file/$HOME/\~}</u>" &

echo "$file"
