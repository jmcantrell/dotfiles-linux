#!/usr/bin/env bash

set -eu

delay=0
directory=$(xdg-user-dir PICTURES)
file_name=desktop_%FT%T%:z
file_type=png

name=${0##*/}
usage="Capture an image of the desktop.

Usage:
    $name [OPTIONS] [FILE]

Options:
    -g GEOMETRY     geometry of region to capture

    -s              select window or region to capture

    -d NUMBER       number of seconds to wait before starting capture
                    (default: $delay)

    -D DIRECTORY    directory in which to store default output file
                    (default: $directory)

    -N FILENAME     filename to use for default output file
                    (default: $file_name)

    -E EXTENSION    extension to use for default output file
                    (default: $file_type)

Arguments:
    FILE            output file (used instead of default)
                    formats any sequences recognized by strftime
                    (default: $directory/$file_name.$file_type)
"

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

while getopts ":g:sd:D:N:E:h" option; do
    case $option in
    g) geometry=$OPTARG ;;
    s) geometry=$(slop -f "%wx%h+%x+%y") ;;
    d) delay=$OPTARG ;;
    D) directory=$OPTARG ;;
    N) file_name=$OPTARG ;;
    E) file_type=$OPTARG ;;
    h)
        printf "%s\n" "$usage"
        exit
        ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

output_file=$(date +"${1:-$directory/$file_name.$file_type}")

options=(-window root)

if [[ -v geometry ]]; then
    options+=(-crop "$geometry")
fi

if ((delay > 0)); then
    canberra-gtk-play -l "$delay" -i message
fi

mkdir -p "$(dirname "$output_file")"
import "${options[@]}" "$output_file"

canberra-gtk-play -i screen-capture &

notify-send -i media-record \
    "Captured image of desktop" \
    "<u>${output_file/$HOME/\~}</u>" &

printf "%s" "$output_file"
