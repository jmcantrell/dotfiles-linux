#!/usr/bin/env bash

# Take a timestamped btrfs snapshot with an optional tag.

set -euo pipefail

tag=${1:-}
ts=$(date +%s)

for name in @ @var @home; do
    snapshot_dir=/.snapshots/$name
    sudo mkdir -p "$snapshot_dir"
    cd "$snapshot_dir"

    sudo btrfs subvolume snapshot -r "/${name#@}" "$ts"

    [[ -n $tag ]] && sudo ln -sfvT "$ts" "$tag"
    sudo ln -sfvT "$ts" latest
done
