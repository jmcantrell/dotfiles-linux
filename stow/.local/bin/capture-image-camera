#!/usr/bin/env bash

set -eu

delay=${DELAY:-3}
device=${DEVICE:-/dev/video0}
file_type=${FILE_TYPE:-png}

me=${0##*/}
usage="Capture an image from a video device.

Usage: $me [OPTIONS] [FILE]

Options:
    -h          show this help message

Arguments:
    FILE        output capture to FILE

Environment Variables:
    DELAY       number of seconds to delay capture (default: $delay)
    DEVICE      video device to use for capture (default: $device) 
    FILE_TYPE   extension to use for output file name (default: $file_type)
"

usage() {
    echo "$usage" >&2
    exit 0
}

die() {
    echo "$me: $*" >&2
    exit 1
}

unset OPTIND OPTARG
while getopts ":h" option; do
    case $option in
    h) usage ;;
    *) die "invalid option: $OPTARG" ;;
    esac
done && shift $((OPTIND - 1))
unset option OPTIND OPTARG

file=${1:-$(xdg-user-dir PICTURES)/camera-$(date +%s).$file_type}
mkdir -p "$(dirname "$file")"

options=(-hide_banner -loglevel error)
options+=(-y -f v4l2 -i "$device" -frames:v 1)

canberra-gtk-play -l "$delay" -i message

ffmpeg "${options[@]}" "$file"

canberra-gtk-play -i screen-capture &
notify-send -i media-record "Captured Photo" "<u>${file/$HOME/\~}</u>" &

echo "$file"
