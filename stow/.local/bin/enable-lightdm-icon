#!/usr/bin/env sh

# Set a user's lightdm icon from an image or the current icon.

set -e

imagefile=${1:-$HOME/.config/me.png}

if ! test -f "$imagefile"; then
    echo "Image $imagefile does not exist"
    exit 1
fi

accounts=/var/lib/AccountsService

if groups | grep -wq wheel; then
    # allow users to add their own user image
    sudo mkdir -p "$accounts"/{icons,users}
    sudo chgrp -R users "$accounts"/{icons,users}
    sudo chmod -R g+rw "$accounts"/{icons,users}
fi

icon=$accounts/icons/$USER

echo "[User]
Icon=$icon
SystemAccount=false
" >"$accounts/users/$USER"

# will not read symlinks or other locations
cp -v "$imagefile" "$icon"
