#!/usr/bin/env bash

# Provide dmenu with list of executables.
# The list is cached and regenerated when needed.

cache=${XDG_CACHE_HOME:-$HOME/.cache}/dmenu
mkdir -p "$cache"
commands=$cache/commands
readarray -d: -t path <<<"$PATH"

# test if cache is outdated
is_cache_bad() {
	stest -q -dr -n "$commands" "${path[@]}"
}

# cache list of executables in given directories
cache_commands() {
	stest -flx "${path[@]}" | sort -u | tee "$commands"
}

# regenerate cache if needed
if [[ ! -f "$commands" ]] || is_cache_bad; then
	cache_commands
fi

cat "$commands"
