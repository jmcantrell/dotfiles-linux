#!/usr/bin/env bash

set -eu

me=${0##*/}
usage="Interact with sway's container marks.

Usage: 
    $me ACTION

Actions:
    set      set mark for current container
    unset    remove mark for current container
    clear    remove all container marks
    goto     focus a marked container
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "%s: line %s: %s\n" "$0" "${BASH_LINENO[0]}" "$*" >&2
    exit 1
}

while getopts ":h" option; do
    case $option in
    h) usage ;;
    *) die "invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:?missing action}

case $action in
set | goto) ;;
unset) exec swaymsg '[con_id="__focused__"] unmark' ;;
clear) exec swaymsg unmark ;;
*) die "invalid action '$action'" ;;
esac

mark=$(swaymsg -t get_marks | jq -r '.[]' | bemenu -p "$action mark")

case $action in
set) exec swaymsg mark "$mark" ;;
goto) exec swaymsg "[con_mark=$mark] focus" ;;
esac
