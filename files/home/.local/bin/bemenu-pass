#!/usr/bin/env bash

set -eu

password_length=16

me=${0##*/}
usage="Interact with pass using bemenu.

Usage:
    $me [OPTIONS] [ACTION]

Options:
    -n NUMBER    generated password length
                 (default: $password_length)

    -q           show a QR code instead of copying to clipboard

Actions:
    choose       choose existing password (default)
    generate     generate a new password

In all cases, the password is copied to the clipboard.
"

pass_dir=${PASSWORD_STORE_DIR:-$HOME/.password-store}

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "%s: line %s: %s\n" "$0" "${BASH_LINENO[0]}" "$*" >&2
    exit 1
}

pass_names() {
    if [[ ! -d $pass_dir ]]; then
        return
    fi

    local file

    find -L "$pass_dir" -type f -name "*.gpg" | while read -r file; do
        local name=${file#"$pass_dir"/}
        name=${name%.gpg}
        printf "%s\n" "$name"
    done
}

show_option=--clip

while getopts ":n:qh" option; do
    case $option in
    n) password_length=$OPTARG ;;
    q) show_option=--qrcode ;;
    h) usage ;;
    *) die "invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:-choose}

case $action in
choose | generate) ;;
*) die "invalid action '$action'" ;;
esac

name=$(pass_names | bemenu -b -p "$action password")

case $action in
choose) pass show "$show_option" "$name" ;;
generate) pass generate "$show_option" --force "$name" "$password_length" ;;
esac

clipboard_seconds=${PASSWORD_STORE_CLIP_TIME:-45}

if [[ $show_option == --clip ]]; then
    notify-send -i edit-copy-symbolic \
        -t $((clipboard_seconds * 1000)) \
        -h string:x-canonical-private-synchronous:"$me" \
        "Password for '$name' copied to clipboard" \
        "Self-destructing in <b>$clipboard_seconds</b> seconds..." &
fi
