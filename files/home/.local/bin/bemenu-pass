#!/usr/bin/env bash

set -euo pipefail
shopt -s nullglob globstar

password_length=16

usage="Interact with pass using bemenu.

Usage:
    ${0##*/} [OPTIONS] [ACTION]

Options:
    -n NUMBER    generated password length
                 (default: $password_length)

    -q           show a QR code instead of copying to clipboard

Actions:
    choose       choose existing password (default)
    generate     generate a new password

In all cases, the password is copied to the clipboard."

pass_names() {
    local dir=${PASSWORD_STORE_DIR:-$HOME/.password-store}

    if [[ ! -d $dir ]]; then
        return 0
    fi

    local path name
    for path in "$dir"/**.gpg; do
        if [[ -f $path ]]; then
            name=${path#"$dir"/}
            name=${name%.gpg}
            printf "%s\n" "$name"
        fi
    done
}

show_option=--clip

while getopts ":n:qh" option; do
    case $option in
    n) password_length=$OPTARG ;;
    q) show_option=--qrcode ;;
    h)
        printf "%s\n" "$usage"
        exit 0
        ;;
    *)
        printf "Invalid option: %s\n" "$OPTARG" >&2
        exit 1
        ;;
    esac
done && shift $((OPTIND - 1))

action=${1:-choose}

case $action in
choose | generate) ;;
*)
    printf "Invalid action: %s\n" "$action" >&2
    exit 1
    ;;
esac

if ! name=$(pass_names | bemenu -b -p "$action password") || [[ -z $name ]]; then
    printf "No password name entered or selected\n" >&2
    exit 1
fi

case $action in
choose) pass show "$show_option" "$name" ;;
generate) pass generate "$show_option" --force "$name" "$password_length" ;;
esac

clipboard_seconds=${PASSWORD_STORE_CLIP_TIME:-45}

if [[ $show_option == --clip ]]; then
    notify-send -i edit-copy-symbolic \
        -t $((clipboard_seconds * 1000)) \
        -h string:x-canonical-private-synchronous:"${0##*/}" \
        "Copied $name to clipboard" \
        "Will clear in <b>$clipboard_seconds</b> seconds..." &
fi
