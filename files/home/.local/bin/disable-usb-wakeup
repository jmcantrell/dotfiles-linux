#!/usr/bin/env bash

# Disable resuming the system on USB device activity.

# Relies on writing the device IDs to a procfs file, which is reset on each
# boot, hence, the systemd service. A helper script is generated when this
# script runs and used to detect the device IDs every time the service is
# started to ensure that any hardware reconfiguration (though unlikely) does
# not break the functionality.

set -euo pipefail

me=${0##*/}
wakeup=/proc/acpi/wakeup
service=/etc/systemd/system/$me.service
script=/usr/local/sbin/$me

sudo tee "$script" >/dev/null <<-EOF
#!/usr/bin/env bash

set -euo pipefail

grep '^[EXOU]HC[0-9]\?\\b.*\\benabled\\b' $wakeup |
    awk '{print \$1}' | tr -d '[:space:]' >$wakeup
EOF

sudo chmod +x "$script"

sudo tee "$service" >/dev/null <<-EOF
[Unit]
Description=disable resuming the system on USB device activity

[Service]
ExecStart=$script

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl enable --now "$(basename "$service")"
