#!/usr/bin/env bash

set -euo pipefail

usage="Raise an alarm after a specified amount of time.

Usage:
    ${0##*/} [OPTIONS] TIMESPEC

Options:
    -n NAME    descriptive name for timer

Examples:
    timer '1 minute'
    timer -n laundry '45 minutes'
    timer -n 'boat tour' '3 hours'
    timer -n 'very specific' 'now + 1 hour + 10 minutes'

See --date option in date(1) for a complete definition of TIMESPEC."

unset name

while getopts ":n:h" option; do
    case $option in
    n) name=$OPTARG ;;
    h)
        printf "%s\n" "$usage"
        exit 0
        ;;
    *)
        printf "Invalid option: %s\n" "$OPTARG" >&2
        exit 1
        ;;
    esac
done && shift $((OPTIND - 1))

if [[ ! -v 1 ]]; then
    printf "The first argument must be a time specification\n" >&2
    exit 1
fi

at "$(date -d "$1" +"%H:%M %Y-%m-%d")" <<EOF
export DISPLAY=$DISPLAY
export WAYLAND_DISPLAY=$WAYLAND_DISPLAY
canberra-gtk-play -i alarm-clock-elapsed &
notify-send -u critical -i dialog-information-symbolic "Timer elapsed" "${name:-}"
EOF
