#!/usr/bin/env bash

set -euo pipefail

usage="Manage text snippets with bemenu.

Usage:
    ${0##*/} -h
    ${0##*/} [OPTIONS] ACTION NAME

Options:
    -D DIRECTORY    directory in which to store snippets

Actions:
    read            read snippet to clipboard
    write           write clipboard to snippet
    append          append clipboard to snippet
    delete          delete snippet
    edit            open snippet in editor
    type            type snippet to active window"

do_read() {
    snip "${snip_options[@]}" read "$1" | wl-copy
}

do_write() {
    wl-paste | snip "${snip_options[@]}" write "$1"
}

do_append() {
    wl-paste | snip "${snip_options[@]}" append "$1"
}

do_type() {
    wtype -s 25 "$(snip "${snip_options[@]}" read "$1")"
}

snip_options=()

while getopts ":D:h" option; do
    case $option in
    D) snip_options+=(-D "$OPTARG") ;;
    h)
        printf "%s\n" "$usage"
        exit 0
        ;;
    *)
        printf "Invalid option: %s\n" "$OPTARG" >&2
        exit 1
        ;;
    esac
done && shift $((OPTIND - 1))

if [[ ! -v 1 ]]; then
    printf "The first argument must be an action\n" >&2
    exit 1
fi

action=$1

case $action in
read | write | append | delete | edit | type) ;;
*)
    printf "Invalid action: %s\n" "$action" >&2
    exit 1
    ;;
esac

if ! name=$(snip list | bemenu -b -p "$action snippet" | head -n1) || [[ -z $name ]]; then
    printf "No snippet name entered or selected\n" >&2
    exit 1
fi

export EDITOR=${VISUAL:-gvim}

case $action in
delete | edit) snip "${snip_options[@]}" "$action" "$name" ;;
*) do_"$action" "$name" ;;
esac
