#!/usr/bin/env bash

set -eu

me=${0##*/}
usage="Manage text snippets with bemenu.

Usage:
    $me [OPTIONS] ACTION NAME

Options:
    -C DIRECTORY    directory in which to store snippets

Actions:
    edit            open snippet in editor
    copy            copy snippet to clipboard
    save            save clipboard to snippet
    type            type snippet to active window
    delete          delete snippet
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "%s: line %s: %s\n" "$0" "${BASH_LINENO[0]}" "$*" >&2
    exit 1
}

do_copy() {
    snip "${snip_options[@]}" read "$1" | wl-copy
}

do_save() {
    wl-paste | snip "${snip_options[@]}" write "$1"
}

do_type() {
    wtype -s 25 "$(snip "${snip_options[@]}" read "$1")"
}

snip_options=()

while getopts ":C:h" option; do
    case $option in
    C) snip_options+=(-C "$OPTARG") ;;
    h) usage ;;
    *) die "invalid option: $OPTARG" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:?missing action}

name=$(snip list | bemenu -b -p "$action snippet")

if [[ -z $name ]]; then
    die "no snippet was selected"
fi

export EDITOR=${VISUAL:-gvim}

case $action in
edit | delete) snip "$action" "$name" ;;
*) do_"$action" "$name" ;;
esac
