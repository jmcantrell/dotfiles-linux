#!/usr/bin/env bash

set -eu

config_dir=${XDG_CONFIG_HOME:-$HOME/.config}/udiskie
keyfile_dir=${XDG_DATA_HOME:-$HOME/.local/share}/udiskie/keyfiles
config_file=$config_dir/config.json

me=${0##*/}
usage="Remember an encrypted disk's keyfile for automatic mounting.

Usage:
    $me [OPTIONS] DEVICE KEYFILE

Options:
    -n NAME         use NAME for the keyfile instead of the UUID

    -C DIRECTORY    udiskie configuration directory
                    (default: ${config_dir/$HOME/\~})

Arguments:
    DEVICE          device to unlock with KEYFILE   
    KEYFILE         file capable of unlocking DEVICE

It's expected that KEYFILE is already (or will be) added to DEVICE.
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "ERROR: %s\n" "$*" >&2
    exit 1
}

unset keyfile_name

while getopts ":s:C:h" option; do
    case $option in
    s) keyfile_name=$OPTARG ;;
    C) config_dir=$OPTARG ;;
    h) usage ;;
    *) die "Invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

if [[ ! -v 1 ]]; then
    die "Missing device"
fi

if [[ ! -v 2 ]]; then
    die "Missing keyfile"
fi

device=$1
keyfile_original=$2

# Lookup the uuid for the device.
if ! uuid=$(sudo blkid -s UUID -o value "$device") || [[ -z $uuid ]]; then
    die "Unable to get UUID for device"
fi

# If the config file doesn't exist, add a skeleton.
if [[ ! -f $config_file ]]; then
    mkdir -p "$config_dir"
    jq -n '.device_config=[]' >"$config_file"
fi

# Keep a copy of the keyfile for later.
mkdir -p "$keyfile_dir"
keyfile_copy=$keyfile_dir/${keyfile_name:-$uuid}.bin
cp -v --preserve=mode "$keyfile_original" "$keyfile_copy"

# Lookup the index for this uuid, if it already exists.
index=$(
    jq --arg uuid "$uuid" \
        '.device_config | map(.id_uuid == $uuid) | index(true)' \
        "$config_file"
)

options=(--arg keyfile "${keyfile_copy/$HOME/\~}")

# Depending on whether or not the uuid exists, either add or update it.
if [[ $index == null ]]; then
    options+=(--arg uuid "$uuid")
    query='.device_config += [{ "id_uuid": $uuid, "keyfile": $keyfile }]'
else
    options+=(--arg index "$index")
    query='.device_config[$index | tonumber].keyfile=$keyfile'
fi

# Update the config file and (re)write it.
jq "${options[@]}" "$query" "$config_file" | sponge "$config_file"
