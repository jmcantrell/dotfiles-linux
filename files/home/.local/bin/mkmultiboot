#!/usr/bin/env bash

set -euo pipefail

device=$1

sudo wipefs --all "$device"

sudo sgdisk -n 1::+1M -c 1:"BIOS boot partition" -t 1:ef02 "$device"
sudo sgdisk -n 2::+50M -c 2:"EFI System" -t 2:ef00 "$device"
sudo sgdisk -n 3::-0 -c 3:"Linux filesystem" -t 3:8300 "$device"

sudo sgdisk --hybrid=1:2:3 "$device"

sudo mkfs.fat -F32 "$device"2
sudo mkfs.ext4 -F "$device"3

mnt_dir=/mnt/multiboot

sudo mkdir -p "$mnt_dir"/{efi,data}

sudo mount "$device"2 "$mnt_dir"/efi
sudo mount "$device"3 "$mnt_dir"/data

sudo mkdir "$mnt_dir"/data/boot

sudo grub-install --target=x86_64-efi --recheck --removable \
    --efi-directory="$mnt_dir"/efi --boot-directory="$mnt_dir"/data/boot

sudo grub-install --target=i386-pc --recheck \
    --boot-directory="$mnt_dir"/data/boot "$device"

sudo umount "$mnt_dir"/{efi,data}
sudo rm -rf "$mnt_dir"
