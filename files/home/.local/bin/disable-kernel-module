#!/usr/bin/env bash

set -eu

me=${0##*/}
usage="Immediately and persistently disable kernel modules.

Usage:
    $me NAME...

Arguments:
    NAME    disable NAME module
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "%s: line %s: %s\n" "$0" "${BASH_LINENO[0]}" "$*" >&2
    exit 1
}

while getopts ":h" option; do
    case $option in
    h) usage ;;
    *) die "invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

# First, ensure all given module names are valid.
for name in "${@:?missing module name(s)}"; do
    if ! modprobe --show --quiet "$name"; then
        die "Invalid module '$name'"
    fi
done

for name in "$@"; do
    # If the module is loaded, unload it.
    if grep -wq "^$name" /proc/modules; then
        sudo rmmod -v "$name"
    fi

    # Ensure that the module is not loaded during boot.
    conf_file=/etc/modprobe.d/disable-$name.conf
    sudo tee "$conf_file" >/dev/null <<<"blacklist $name"
done
