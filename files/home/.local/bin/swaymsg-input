#!/usr/bin/env bash

set -eu

prompt=input

me=${0##*/}
usage="Prompt the user for sway command input.

Usage:
    $me [OPTIONS] FORMAT

Options:
    -e         treat an empty response as an error

    -p TEXT    use TEXT for input prompt 
               (default: $prompt)

    -s PATH    use sway socket PATH

Arguments:
    FORMAT     use FORMAT for sway command
               (%s will be replaced by user input)
"

usage() {
    printf "%s\n" "$usage"
    exit 0
}

die() {
    printf "%s: line %s: %s\n" "$0" "${BASH_LINENO[0]}" "$*" >&2
    exit 1
}

ipc_command=(swaymsg)
treat_empty_as_error=0

while getopts ":p:es:h" option; do
    case $option in
    p) prompt=$OPTARG ;;
    e) treat_empty_as_error=1 ;;
    s) ipc_command+=(-s "$OPTARG") ;;
    h) usage ;;
    *) die "invalid option '$OPTARG'" ;;
    esac
done && shift $((OPTIND - 1))

format=${1:?missing command format}

# Prompt user for input.
reply=$(bemenu -p "$prompt" </dev/null)

if ((treat_empty_as_error)) && [[ -z $reply ]]; then
    exit 1
fi

# Substitute user's reply into message format.
printf -v message "$format" "$reply"

# Send command to sway.
exec "${ipc_command[@]}" "$message"
